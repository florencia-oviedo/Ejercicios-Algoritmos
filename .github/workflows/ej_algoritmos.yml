name: Cerrar issues por cada ejercicio

on: [push]

jobs:
  manage-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Detectar y cerrar issue por mensaje de commit
        uses: actions/github-script@v7
        with:
          script: |
            const commitMessage = context.payload.head_commit.message;
            console.log(`Mensaje del commit: ${commitMessage}`);
            
            // Detectar si el mensaje contiene "ejercicio" seguido del nombre
            const match = commitMessage.match(/ejercicio\s+(.+)/i);
            
            if (match) {
              const ejercicioNombre = match[1].trim();
              const issueTitle = `Ejercicio ${ejercicioNombre}`;
              
              console.log(`Buscando issue: ${issueTitle}`);
              
              // Buscar issue abierta
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              });
              
              const issue = issues.find(i => 
                i.title.toLowerCase() === issueTitle.toLowerCase()
              );
              
              if (issue) {
                // Cerrar issue existente
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `✅ Ejercicio resuelto en commit ${context.sha.substring(0, 7)}`
                });
                
                console.log(`Issue cerrada: ${issueTitle}`);
              } else {
                // Crear y cerrar issue nueva
                const { data: newIssue } = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: `✅ Ejercicio completado en commit ${context.sha.substring(0, 7)}`,
                  labels: ['ejercicio', 'completado']
                });
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: newIssue.number,
                  state: 'closed'
                });
                
                console.log(`Issue creada y cerrada: ${issueTitle}`);
              }
            } else {
              console.log('El commit no sigue el formato "ejercicio <nombre>"');
            }